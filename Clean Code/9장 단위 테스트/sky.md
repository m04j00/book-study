# 09. 단위 테스트

> 애자일과 TDD 덕택에 단위 테스트를 자동화하는 프로그래머들이 이미 많아졌으며 점점 더 늘어나는 추세다. 하지만 우리 분야에 테스트를 추가하려고 급하게 서두르는 와중에 많은 프로그래머들이 제대로 된 테스트 케이스를 작성해야 한다는 좀 더 미묘한 (그리고 더 중요한) 사실을 놓쳐버렸다.
> 

<br/>

### TDD 법칙 세 가지

→ 저자(로버트 C.마틴)이 주장한 TDD 3원칙

- 첫째 법칙 : 실패하는 단위 테스트를 작성할 때까지 실제 코드를 작성하지 않는다.
- 둘째 법칙 : 컴파일은 실패하지 않으면서 실행이 실패하는 정도로만 단위 테스트를 작성한다.
- 셋째 법칙 : 현재 실패하는 테스트를 통과할 정도로만 실제 코드를 작성한다.

위 세 가지의 규칙을 따르면 테스트 코드와 실제 코드는 함께 나온다. 사실상 실제 코드를 전부 테스트하는 테스트 케이스가 나오지만, 실제 코드와 맞먹을 정도로 방대한 테스트는 심각한 관리 문제를 유발한다.

<br/>

### 깨끗한 테스트 코드 유지하기

잘 설계하거나 주의해서 분리하지 않은 일회용 테스트 코드를 짜오다가 자동화된 단위 테스트 슈트를 짜는 것은 쉽지 않다. 하지만 지저분한 테스트 코드는 테스트를 안 하는 것보다 더 못하다. 

> 문제는 실제 코드가 진화하면 테스트 코드도 변해야 한다는 데 있다. (생략) 테스트 코드가 복잡할수록 실제 코드를 짜는 시간보다 테스트 케이스를 추가하는 시간이 더 걸리기 십상이다. (생략) 그래서 테스트 코드는 계속해서 늘어나는 부담이 되버린다.
> 

이 때문에 테스트 케이스를 유지 및 보수하는 비용이 늘어나고 결국 테스트 슈트를 폐기해야 하는 상황이 오기도 하는데, 테스트 슈트가 없으면 프로그램이 안전하다는 사실을 증명할 수 없다.
결국 코드가 망가지는 결론이 나오기도 한다.

> **테스트 코드는 실제 코드 못지 않게 중요하다.**
> 

- 테스트는 유연성, 유지보수성, 재사용성을 제공한다.
    - 코드에 위 3가지 요소를 제공하는 버팀목이 바로 단위 테스트이다. 테스트 케이스가 있으면 변경이 쉬워지기 때문이다.

<br/>

### 깨끗한 테스트 코드

> 깨끗한 테스트 코드를 만들려면? 세 가지가 필요하다. 가독성, 가독성, 가독성.
> 

> 테스트 코드에서 가독성을 높이려면? 여느 코드와 마찬가지다. 명료성, 단순성, 풍부한 표현력이 필요하다.
> 

**BUILD-OPERATE-CHECK 패턴**

- BUILD : 테스트 자료를 만든다.
- OPERATE : 테스트 자료를 조작한다.
- CHECK : 조작한 결과를 확인한다.

+) given, when, then을 주석으로 사용하는것이 관례적이다.


**도메인에 특화된 테스트 언어 = DSL**

→ 숙련된 개발자라면 자기 코드를 좀 더 간결하고 표현력이 좋은 코드로 리팩토링 하는것이 마땅하다. DSL을 통해 구현한 함수와 유틸리티는 잡다한 코드를 계속 리팩터링하다가 진화된 API이다.

> 흔히 쓰는 시스템 조작 API를 사용하는 대신 API 위에다 함수와 유틸리티를 구현한 후 그 함수와 유틸리티를 사용하므로 테스트 코드를 짜기도 읽기도 쉬워진다. (생략) 즉, 테스트를 구현하는 당사자와 나중에 테스트를 읽어볼 독자를 도와주는 테스트 언어다.
> 

**이중 표준**

테스트 API코드에 적용하는 표준과 실제 코드에 적용하는 표준은 다르다. 테스트 API 코드는 단순-간결-좋은 표현력을 가지고 있어야 하지만 실제 코드만큼 효율적일 필요는 없다.
게다가 테스트 환경은 실제 시스템과 다르게 메모리 등의 자원이 제한적일 가능성이 낮다. 
**즉 CPU 효율과 메모리를 얼만큼 사용하는지는 코드의 깨끗함과 관련이 없다.** 


<br/>

### 테스트 당 assert 하나

테스트를 분리하면 중복되는 코드가 많아지는데, 아래 두 가지 방법을 사용하여 중복을 제거할 수 있다.

**TEMPLATE METHOD 패턴**

- given, when의 공통부분은 부모 클래스에서, 서로 다른 when 부분은 각자 자식 클래스를 만들어 구현하는 방식

**@Before / @Test**

- 완전히 독자적인 테스트 클래스를 만들어 @Before 함수에 given/when 부분을 넣고 @Test 함수에 then 부분을 넣는것

> 가장 좋은 규칙은 “개념 당 assert문 수를 최소로 줄여라”와 “테스트 함수 하나는 개념 하나만 테스트하라”라 하겠다.
> 

<br/>

### F.I.R.S.T

→ 깨끗한 테스트가 따르는 다섯 가지 규칙

- Fast / 빠르게
- Independent / 독립적으로 : 각 테스트는 서로 의존하면 안 된다.
- Repeatable / 반복가능하게 : 테스트가 돌아가지 않는 환경이 하나라도 있으면 안된다.
- Self-Validating / 자가검증하는 : 테스트 결과는 bool이어야 한다.
- Timely / 적시에 : 탄위 테스트는 테스트하려는 실제 코드를 구현하기 직전에 구현한다.
